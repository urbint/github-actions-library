name: Build and Scan Docker Image

description: Build a Docker image and scan it for vulnerabilities using Trivy.

inputs:
  image_name:
    description: 'The name and tag of the Docker image (e.g., my-image:latest).'
    required: true
  dockerfile:
    description: 'Path to the Dockerfile.'
    required: true
    default: 'Dockerfile'
  context:
    description: 'Build context path.'
    required: true
    default: '.'  # Default to current directory
  node-version:
    description: 'Node.js version to use'
    required: true
    default: '20'  # Default Node.js version
  registry-url:
    description: 'Registry URL for NPM packages'
    required: true
    default: 'https://npm.pkg.github.com'  # Default registry URL
  node-auth-token:
    description: 'NPM Auth Token for accessing private packages'
    required: true
    default: ''  # Default can be blank

runs:
  using: 'composite'
  steps:
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ inputs.node-version }}
        registry-url: ${{ inputs.registry-url }}  # Pass the registry URL

    - name: Install dependencies
      run: |
        yarn install
      env:
        NODE_AUTH_TOKEN: ${{ inputs.node-auth-token }}  # Use the provided auth token
      shell: bash  # Specify the shell for this step

    - name: Build the application
      run: |
        yarn build  # Add the build step
      shell: bash  # Specify the shell for this step

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      id: build
      shell: bash  # Specify the shell for this step
      run: |
        docker build -t ${{ inputs.image_name }} -f ${{ inputs.dockerfile }} ${{ inputs.context }}

    - name: List Docker Images
      shell: bash  # Specify the shell for this step
      run: docker images

    - name: Cache Trivy DB
      id: cache-trivy-db
      uses: actions/cache@v3
      with:
        path: ~/.cache/trivy
        key: trivy-db-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          trivy-db-${{ runner.os }}-
          trivy-db-

    - name: Install Trivy
      shell: bash  # Specify the shell for this step
      run: |
        sudo apt-get update && sudo apt-get install wget -y
        wget https://github.com/aquasecurity/trivy/releases/download/v0.45.1/trivy_0.45.1_Linux-64bit.deb
        sudo dpkg -i trivy_0.45.1_Linux-64bit.deb

    # Set a custom TMPDIR to prevent "no space left on device" error
    - name: Set TMPDIR to a larger location
      run: |
        mkdir -p /home/runner/tmp
        export TMPDIR=/home/runner/tmp
        echo "TMPDIR set to /home/runner/tmp"
      shell: bash

    - name: Update Trivy DB
      env:
        TMPDIR: /home/runner/tmp
      shell: bash  # Specify the shell for this step
      run: |
        trivy db update || echo "Failed to update DB, using cached version."

    - name: Clean up Docker to Free Space
      shell: bash  # Specify the shell for this step
      run: |
        echo "=== Docker Disk Usage Before Cleanup ==="
        docker system df || echo "Docker system df failed"
        echo ""
        echo "=== Cleaning up Docker to free space ==="
        # Remove all build cache (safest, doesn't affect images)
        docker builder prune -a -f || echo "Docker builder prune failed"
        # Remove dangling images (images without tags)
        docker image prune -f || echo "Docker image prune failed"
        # Remove unused containers
        docker container prune -f || echo "Docker container prune failed"
        # Remove unused volumes
        docker volume prune -f || echo "Docker volume prune failed"
        echo ""
        echo "=== Docker Disk Usage After Cleanup ==="
        docker system df || echo "Docker system df failed"

    - name: Check Disk Usage Before Scan
      env:
        TMPDIR: /home/runner/tmp
      shell: bash  # Specify the shell for this step
      run: |
        echo "=== Disk Usage Overview ==="
        df -h
        echo ""
        echo "=== TMPDIR Location Disk Usage ==="
        df -h /home/runner/tmp || df -h /home/runner
        echo ""
        echo "=== Current TMPDIR Value ==="
        echo "TMPDIR=${TMPDIR:-/tmp}"
        echo ""
        echo "=== Space in /home/runner/tmp ==="
        du -sh /home/runner/tmp 2>/dev/null || echo "Directory not found or empty"
        echo ""
        echo "=== Docker Disk Usage ==="
        docker system df || echo "Docker system df failed"
        echo ""
        echo "=== Top Disk Consumers ==="
        du -h /home/runner 2>/dev/null | sort -rh | head -10 || echo "Could not check /home/runner"

    - name: Trivy Scan
      id: trivy
      env:
        TMPDIR: /home/runner/tmp
      shell: bash  # Specify the shell for this step
      run: |
        trivy image --severity HIGH,CRITICAL ${{ inputs.image_name }}
      continue-on-error: true

    - name: Fail if Trivy Scan Fails
      if: ${{ steps.trivy.outcome != 'success' }}
      shell: bash  # Specify the shell for this step
      run: |
        echo "Trivy scan failed, cannot proceed."
        exit 1
