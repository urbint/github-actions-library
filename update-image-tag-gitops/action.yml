name: "Update Image Tag"
description: "Updates the image tag in a specified kustomization.yaml file."
inputs:
  repo:
    description: "The repository to update."
    required: true
  file_path:
    description: "The path to the kustomization.yaml file to update."
    required: true
  tag_key:
    description: "The key for the new image tag in the YAML."
    required: true
  image_name:
    description: "The name of the image to update."
    required: true
  tag:
    description: "The tag value to set."
    required: true
  branch:
    description: "The branch to update."
    required: true
  token:
    description: "GitHub token for authentication."
    required: true

runs:
  using: "composite"
  steps:
    - name: Check out repository
      uses: actions/checkout@v3
      with:
        repository: ${{ inputs.repo }}
        token: ${{ inputs.token }}
        ref: "${{ inputs.branch }}"
        path: gitops

    - name: Update image tag
      shell: bash
      run: |
          pwd
          ls -la
  
          cd gitops # Navigate to the cloned directory
          git checkout "${{ inputs.branch }}"
          ls -la
          
          # Print the current contents of the kustomization.yaml file before updating
          echo "=== Before Update ==="
          cat "${{ inputs.file_path }}"

          # Update the image tag using yq
          yq eval ".images[] |= select(.name == \"${{ inputs.image_name }}\") |= .newTag = \"${{ inputs.tag }}\"" -i "${{ inputs.file_path }}"

          # Print the contents of the kustomization.yaml file after the update
          echo "=== After Update ==="
          cat "${{ inputs.file_path }}"

          # Check if there are changes to commit
          git diff "${{ inputs.file_path }}"

          # Optionally, check if the file is marked as changed (useful for debugging)
          if ! git diff --quiet; then
            echo "File has changes. You can proceed with commit and push."
          else
            echo "No changes detected in the file."
          fi
